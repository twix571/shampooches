{% extends "mainapp/base.html" %}
{% load static %}
{% load core_tags %}
{% block title %}Admin Dashboard - {{ site_config.business_name|default:"Shampooches"}}{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <!-- Header -->
    <header class="bg-white/70 border-b border-[var(--gold)]/30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 rounded-xl shadow-sm flex items-center justify-center bg-[#D4AF37]">
                        <svg class="w-5 h-5 text-[var(--primary-black)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-semibold text-[var(--primary-black)]">Shampooches</span>
                        <span class="text-xs text-[var(--gold)] -mt-1">Admin Dashboard</span>
                    </div>
                </div>
                <nav class="flex items-center space-x-6">
                    <a href="{% url 'customer_landing' %}" class="text-[var(--dark-gray)] hover:text-[var(--primary-black)] text-sm font-medium transition-colors hover:bg-[var(--light-gold)] px-3 py-2 rounded-lg">Customer Landing</a>
                    <a href="{% url 'staff_contact_page' %}" class="text-[var(--dark-gray)] hover:text-[var(--primary-black)] text-sm font-medium transition-colors hover:bg-[var(--light-gold)] px-3 py-2 rounded-lg">Contact</a>
                    <a href="{% url 'custom_logout' %}" class="px-4 py-2 bg-[#0F172A] text-white rounded-lg hover:bg-black transition shadow-sm text-sm font-medium">Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Alert Banner (if pending confirmations) -->
        {% if metrics.alerts.has_alerts %}
        <div class="mb-6 bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-center space-x-4">
            <div class="flex-shrink-0">
                <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77-1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-amber-800">
                    {% if metrics.alerts.pending_confirmations > 0 %}
                        {{ metrics.alerts.pending_confirmations }} appointment{{ metrics.alerts.pending_confirmations|pluralize }} pending confirmation
                    {% endif %}
                    {% if metrics.alerts.upcoming_unconfirmed > 0 %}
                        {% if metrics.alerts.pending_confirmations > 0 %} / {% endif %}
                        {{ metrics.alerts.upcoming_unconfirmed }} upcoming unconfirmed
                    {% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Two-Column Layout -->
        <div class="grid lg:grid-cols-[20%_1fr] gap-6 mb-8 items-start">
            <!-- Today's Schedule (First Content) -->
            <div class="lg:row-span-3">
                <div class="bg-white rounded-2xl shadow-sm border border-[var(--gold)]/30 sticky top-4">
                    <div class="px-4 py-4 border-b border-[var(--gold)]/30">
                        <h2 class="text-base font-semibold text-[var(--primary-black)]">Today's Schedule</h2>
                        <span class="text-xs text-[var(--text-gray)]">{{ today|date:"F j, Y" }}</span>
                    </div>
                    <div class="p-3 max-h-[400px] overflow-y-auto custom-scrollbar">
                        <style>
                            .custom-scrollbar::-webkit-scrollbar {
                                width: 8px;
                            }
                            .custom-scrollbar::-webkit-scrollbar-thumb {
                                background: #D4AF37;
                                border-radius: 4px;
                            }
                            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                                background: #C59F2D;
                            }
                            .appointment-pending { border-color: #F59E0B !important; background-color: #FEF3C7 !important; }
                            .appointment-pending .time-badge { color: #D97706 !important; }
                            .appointment-confirmed { border-color: #22C55E !important; background-color: #F0FDF4 !important; }
                            .appointment-confirmed .time-badge { color: #16A34A !important; }
                            .appointment-completed { border-color: #9CA3AF !important; background-color: #F9FAFB !important; }
                            .appointment-completed .time-badge { color: #6B7280 !important; }
                            .appointment-cancelled { border-color: #EF4444 !important; background-color: #FEF2F2 !important; }
                            .appointment-cancelled .time-badge { color: #DC2626 !important; text-decoration: line-through; }
                        </style>
                        {% if today_schedule %}
                            <!-- Active Appointments -->
                            {% regroup today_schedule by status as status_groups %}
                            {% for status, appointments in status_groups %}
                                {% if status != 'cancelled' %}
                                    <div class="space-y-3 mb-4">
                                        <h3 class="text-xs font-semibold text-[var(--dark-gray)] uppercase tracking-wide">{{ status|title }}</h3>
                                        {% for appointment in appointments %}
                                            <div class="group p-3 rounded-lg border hover:scale-[1.02] transition-all duration-200 appointment-{{ status }}">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="text-sm font-semibold time-badge">
                                                        {% if appointment.time %}
                                                            {{ appointment.time|time:"h:i A" }}
                                                        {% else %}
                                                            TBA
                                                        {% endif %}
                                                    </div>
                                                    {% if status == 'pending' %}
                                                        <select
                                                            data-appointment-id="{{ appointment.id }}"
                                                            class="status-select px-2 py-1 text-xs font-medium rounded border border-[#D97706]/30 bg-white text-[#92400E] hover:border-[#D97706] focus:outline-none transition-all cursor-pointer">
                                                            <option value="pending" selected>Pending</option>
                                                            <option value="confirmed">Confirmed</option>
                                                            <option value="completed">Completed</option>
                                                            <option value="cancelled">Cancelled</option>
                                                        </select>
                                                    {% elif status == 'confirmed' %}
                                                        <select
                                                            data-appointment-id="{{ appointment.id }}"
                                                            class="status-select px-2 py-1 text-xs font-medium rounded border border-[#16A34A]/30 bg-white text-[#15803D] hover:border-[#16A34A] focus:outline-none transition-all cursor-pointer">
                                                            <option value="pending">Pending</option>
                                                            <option value="confirmed" selected>Confirmed</option>
                                                            <option value="completed">Completed</option>
                                                            <option value="cancelled">Cancelled</option>
                                                        </select>
                                                    {% elif status == 'completed' %}
                                                        <select
                                                            data-appointment-id="{{ appointment.id }}"
                                                            class="status-select px-2 py-1 text-xs font-medium rounded border border-[#6B7280]/30 bg-white text-[#374151] hover:border-[#6B7280] focus:outline-none transition-all cursor-pointer">
                                                            <option value="pending">Pending</option>
                                                            <option value="confirmed">Confirmed</option>
                                                            <option value="completed" selected>Completed</option>
                                                            <option value="cancelled">Cancelled</option>
                                                        </select>
                                                    {% endif %}
                                                </div>
                                                <p class="text-sm font-medium text-[var(--primary-black)]">{{ appointment.customer.name }}</p>
                                                <p class="text-xs text-[var(--text-gray)]">{{ appointment.service.name }} · {{ appointment.dog_name }}</p>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endfor %}

                            <!-- Cancelled Appointments (Collapsible) -->
                            {% for status, appointments in status_groups %}
                                {% if status == 'cancelled' %}
                                    <div class="border-t border-[var(--gold)]/30 pt-3">
                                        <button
                                            type="button"
                                            class="w-full flex items-center justify-between px-3 py-2 text-xs font-semibold text-[var(--text-gray)] hover:text-[var(--primary-black)] transition-colors"
                                            onclick="toggleCancelled(this)">
                                            <span>Cancelled ({{ appointments|length }})</span>
                                            <svg class="w-4 h-4 transform transition-transform rotate-[-90deg]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                        <div class="cancelled-container hidden mt-2 space-y-3 px-1">
                                            {% for appointment in appointments %}
                                                <div class="group p-3 rounded-lg border opacity-75 appointment-cancelled">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="text-sm font-semibold time-badge">
                                                            {% if appointment.time %}
                                                                {{ appointment.time|time:"h:i A" }}
                                                            {% else %}
                                                                TBA
                                                            {% endif %}
                                                        </div>
                                                        <select
                                                            data-appointment-id="{{ appointment.id }}"
                                                            class="status-select px-2 py-1 text-xs font-medium rounded border border-[#DC2626]/30 bg-white text-[#991B1B] hover:border-[#DC2626] focus:outline-none transition-all cursor-pointer">
                                                            <option value="pending">Pending</option>
                                                            <option value="confirmed">Confirmed</option>
                                                            <option value="completed">Completed</option>
                                                            <option value="cancelled" selected>Cancelled</option>
                                                        </select>
                                                    </div>
                                                    <p class="text-sm font-medium text-[var(--primary-black)]">{{ appointment.customer.name }}</p>
                                                    <p class="text-xs text-[var(--text-gray)]">{{ appointment.service.name }} · {{ appointment.dog_name }}</p>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8">
                                <div class="w-12 h-12 bg-[var(--light-gold)]/30 rounded-xl flex items-center justify-center mx-auto mb-3">
                                    <svg class="w-6 h-6 text-[var(--gold)]/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <p class="text-[var(--text-gray)] font-medium text-sm">No appointments today</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Metrics and Actions Grid -->
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-5 gap-4">
                <!-- Weekly Revenue -->
                <div class="bg-white rounded-xl shadow-sm border border-[var(--gold)]/30 p-5">
                    <p class="text-sm font-medium text-[var(--dark-gray)] mb-2">Weekly Revenue</p>
                    <p class="text-xl font-bold text-[var(--primary-black)]">${{ metrics.revenue.weekly_revenue|floatformat:2 }}</p>
                </div>

                <!-- Appointments Today -->
                <div class="bg-white rounded-xl shadow-sm border border-[var(--gold)]/30 p-5 cursor-pointer hover:bg-gray-50 transition-colors"
                     data-modal-url="{% url 'appointments_modal' %}">
                    <p class="text-sm font-medium text-[var(--dark-gray)] mb-2">Appointments Today</p>
                    <p class="text-xl font-bold text-[var(--primary-black)]">{{ metrics.appointments.today_appointments|floatformat:0 }}</p>
                </div>

                <!-- Pending Actions -->
                <div class="bg-white rounded-xl shadow-sm border border-[var(--gold)]/30 p-5">
                    <p class="text-sm font-medium text-[var(--dark-gray)] mb-2">Pending Actions</p>
                    <p class="text-xl font-bold text-[var(--primary-black)]">{{ metrics.appointments.pending_appointments|floatformat:0 }}</p>
                </div>

                <!-- Active Customers -->
                <div class="bg-white rounded-xl shadow-sm border border-[var(--gold)]/30 p-5">
                    <p class="text-sm font-medium text-[var(--dark-gray)] mb-2">Active Customers</p>
                    <p class="text-xl font-bold text-[var(--primary-black)]">{{ metrics.customers.active_customers|floatformat:0 }}</p>
                </div>

                <!-- Monthly Revenue -->
                <div class="bg-white rounded-xl shadow-sm border border-[var(--gold)]/30 p-5">
                    <p class="text-sm font-medium text-[var(--dark-gray)] mb-2">Monthly Revenue</p>
                    <p class="text-xl font-bold text-[var(--primary-black)]">${{ metrics.revenue.monthly_revenue|floatformat:2 }}</p>
                </div>

                <!-- Quick Action Cards -->
                {% for card in action_cards %}
                    {% include "mainapp/partials/action_card_partial.html" with card=card %}
                {% endfor %}
            </div>
        </div>
    </main>
</div>

<script>
(function() {
    // Handle appointment status changes
    document.addEventListener('change', function(event) {
        const select = event.target.closest('.status-select');
        if (!select) return;

        const appointmentId = select.getAttribute('data-appointment-id');
        const newStatus = select.value;

        // Disable select while updating
        select.disabled = true;

        // Get CSRF token
        const getCsrfToken = function() {
            const token = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
            if (token) return token;

            const cookieValue = `; ${document.cookie}`;
            const parts = cookieValue.split(`; csrftoken=`);
            if (parts.length === 2) return parts.pop().split(';').shift();

            return '';
        };

        // Update appointment status via API
        fetch('/api/v1/admin/appointments/update-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                appointment_id: appointmentId,
                status: newStatus
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to update status');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success notification
                if (window.showNotification && typeof window.showNotification === 'function') {
                    window.showNotification(data.message || 'Status updated successfully', 'success');
                }

                // Update the status badge by re-rendering the page for the badge
                // We'll need to rebuild the badge HTML based on the new status
                const appointmentRow = select.closest('.group');
                if (appointmentRow) {
                    // Remove the old badge and add a new one
                    const oldBadge = appointmentRow.querySelector('[class*="inline-block"]');
                    if (oldBadge) {
                        const statusStyles = {
                            'pending': 'bg-[#FDF6CC] text-[#967D21] border-[#D4AF37]',
                            'confirmed': 'bg-[#F0FDF4] text-[#16A34A] border-[#22C55E]',
                            'completed': 'bg-[#FEFDF5] text-[#584B0B] border-[#E5E7EB]',
                            'cancelled': 'bg-[#F3F4F6] text-[#6B7280] border-[#D1D5DB]',
                        };
                        const displayStatus = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                        const style = statusStyles[newStatus] || statusStyles['cancelled'];
                        oldBadge.outerHTML = `<span class="inline-block px-3 py-1.5 text-xs font-semibold rounded-lg shadow-sm ${style}">${displayStatus}</span>`;
                    }
                }
            } else {
                throw new Error(data.message || 'Update failed');
            }
        })
        .catch(error => {
            console.error('Error updating appointment status:', error);
            if (window.showNotification && typeof window.showNotification === 'function') {
                window.showNotification('Failed to update status: ' + error.message, 'error');
            }
            // Revert select to previous value
            select.value = select.dataset.previousValue || 'pending';
        })
        .finally(() => {
            // Store new value as previous for next change
            select.dataset.previousValue = newStatus;
            // Re-enable select
            select.disabled = false;
        });
    });

    // Store initial values on page load
    document.querySelectorAll('.status-select').forEach(select => {
        select.dataset.previousValue = select.value;
    });

    // Toggle cancelled appointments section
    window.toggleCancelled = function(button) {
        const container = button.nextElementSibling;
        const arrow = button.querySelector('svg');

        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            arrow.classList.remove('rotate-[-90deg]');
            arrow.classList.add('rotate-0');
        } else {
            container.classList.add('hidden');
            arrow.classList.remove('rotate-0');
            arrow.classList.add('rotate-[-90deg]');
        }
    };

})();
</script>
{% endblock %}
