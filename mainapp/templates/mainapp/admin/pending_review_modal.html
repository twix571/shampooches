{% load static %}
{% load core_tags %}

<div class="p-6">
    {% include "mainapp/partials/modal_header.html" with title="Review Pending Appointments" %}

    <!-- Overdue Section: Past Pending Appointments -->
    {% if overdue_pending %}
        <div class="mb-6 bg-red-100 border border-red-300 rounded-xl p-4 opacity-90">
            <h3 class="text-sm font-semibold text-red-900 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77-1.333.192 3 1.732 3z"></path>
                </svg>
                Overdue - Past Pending Appointments ({{ overdue_pending|length }})
            </h3>
            <div class="space-y-2">
                {% regroup overdue_pending by date as overdue_by_date %}
                {% for date in overdue_by_date %}
                    <div class="bg-white rounded-lg p-3 border-2 border-red-300 shadow-sm">
                        <h4 class="text-xs font-semibold text-red-700 mb-2">{{ date.grouper|date:"l, F j, Y" }}</h4>
                        <div class="space-y-2">
                            {% for appointment in date.list %}
                                <div class="flex items-center justify-between{% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %} py-2{% else %} py-1{% endif %} border-2 {% if appointment.same_time_count > 1 %}border-purple-500 bg-purple-50 px-2 rounded-lg{% elif appointment.same_day_count > 1 %}border-indigo-400 bg-indigo-50 px-2 rounded-lg{% else %}border-red-200 px-2 rounded-lg{% endif %} {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}relative{% endif %}">
                                    {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                    <div class="absolute top-0 right-0 px-2 py-0.5 bg-gradient-to-l {% if appointment.same_time_count > 1 %}from-purple-600 to-purple-500{% else %}from-indigo-600 to-indigo-500{% endif %} text-white text-xs font-bold rounded-bl-lg">
                                        {% if appointment.same_time_count > 1 %}{{ appointment.same_time_count }} DOGS @ Same Time{% else %}{{ appointment.same_day_count }} DOGS Today{% endif %}
                                    </div>
                                    {% endif %}

                                    <div class="flex items-center gap-3{% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %} pr-28{% endif %}">
                                        {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                        <div class="flex-shrink-0">
                                            <svg class="w-5 h-5 {% if appointment.same_time_count > 1 %}text-purple-600{% else %}text-indigo-600{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 2a3 3 0 00-3 3v1a2 2 0 00-2 2v1a2 2 0 102 0V8h.5a3.5 3.5 0 013.5 3.5v.75a.75.75 0 001.5 0v-.75A5 5 0 005.5 6H5V5a3 3 0 013-3zm-2 9.5a2 2 0 00-2 2v.5a.75.75 0 001.5 0v-.5a.5.5 0 01.5-.5h5a.5.5 0 01.5.5v.5a.75.75 0 001.5 0v-.5a2 2 0 00-2-2H8z"/>
                                            </svg>
                                        </div>
                                        {% endif %}
                                        <span class="text-sm font-semibold text-gray-800 min-w-[70px]">
                                            {% if appointment.time %}
                                                {{ appointment.time|time:"h:i A" }}
                                            {% else %}
                                                TBA
                                            {% endif %}
                                        </span>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-800{% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %} flex items-center gap-1{% endif %}">
                                                {{ appointment.customer.name }}
                                                {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                                <svg class="w-4 h-4 {% if appointment.same_time_count > 1 %}text-purple-600{% else %}text-indigo-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                </svg>
                                                {% endif %}
                                            </p>
                                            <p class="text-xs text-gray-500">{{ appointment.service.name }} · {{ appointment.dog_name }}</p>
                                        </div>
                                    </div>
                                    <select
                                        data-appointment-id="{{ appointment.id }}"
                                        class="status-select px-2 py-1 text-xs font-medium rounded border border-[#D97706]/30 bg-white text-[#92400E] hover:border-[#D97706] focus:outline-none transition-all cursor-pointer">
                                        <option value="pending" selected>Pending</option>
                                        <option value="confirmed">Confirm</option>
                                        <option value="cancelled">Cancel</option>
                                    </select>
                                </div>
                                {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                <div class="mt-1 text-xs {% if appointment.same_time_count > 1 %}text-purple-700 bg-purple-100/50{% else %}text-indigo-700 bg-indigo-100/50{% endif %} px-2 py-0.5 rounded inline-block mx-2">
                                    <span class="font-medium">Multi-Dog:</span> {% if appointment.same_time_count > 1 %}{{ appointment.same_time_count }} dogs same time{% else %}{{ appointment.same_day_count }} dogs same day{% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Urgent Section: Today's Pending -->
    {% if today_pending %}
        <div class="mb-6 bg-red-50 border border-red-200 rounded-xl p-4">
            <h3 class="text-sm font-semibold text-red-800 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77-1.333.192 3 1.732 3z"></path>
                </svg>
                Urgent - Today's Pending Appointments ({{ today_pending|length }})
            </h3>
            <div class="space-y-2">
                {% for appointment in today_pending %}
                    <div class="bg-white rounded-lg p-3 border-2 {% if appointment.same_time_count > 1 %}border-purple-500 bg-purple-50{% elif appointment.same_day_count > 1 %}border-indigo-400 bg-indigo-50{% else %}border-red-100{% endif %} shadow-sm hover:shadow transition-shadow relative overflow-hidden">
                        {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                        <div class="absolute top-0 right-0 px-2 py-0.5 bg-gradient-to-l {% if appointment.same_time_count > 1 %}from-purple-600 to-purple-500{% else %}from-indigo-600 to-indigo-500{% endif %} text-white text-xs font-bold rounded-bl-lg">
                            {% if appointment.same_time_count > 1 %}{{ appointment.same_time_count }} DOGS @ Same Time{% else %}{{ appointment.same_day_count }} DOGS Today{% endif %}
                        </div>
                        {% endif %}

                        <div class="flex items-center justify-between{% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %} pr-28{% endif %} mb-2">
                            <div class="flex items-center gap-3">
                                {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                <div class="flex-shrink-0">
                                    <svg class="w-6 h-6 {% if appointment.same_time_count > 1 %}text-purple-600{% else %}text-indigo-600{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 2a3 3 0 00-3 3v1a2 2 0 00-2 2v1a2 2 0 102 0V8h.5a3.5 3.5 0 013.5 3.5v.75a.75.75 0 001.5 0v-.75A5 5 0 005.5 6H5V5a3 3 0 013-3zm-2 9.5a2 2 0 00-2 2v.5a.75.75 0 001.5 0v-.5a.5.5 0 01.5-.5h5a.5.5 0 01.5.5v.5a.75.75 0 001.5 0v-.5a2 2 0 00-2-2H8z"/>
                                    </svg>
                                </div>
                                {% endif %}
                                <span class="text-sm font-semibold text-gray-800 min-w-[70px]">
                                    {% if appointment.time %}
                                        {{ appointment.time|time:"h:i A" }}
                                    {% else %}
                                        TBA
                                    {% endif %}
                                </span>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800{% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %} flex items-center gap-1{% endif %}">
                                        {{ appointment.customer.name }}
                                        {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                        <svg class="w-4 h-4 {% if appointment.same_time_count > 1 %}text-purple-600{% else %}text-indigo-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                        {% endif %}
                                    </p>
                                    <p class="text-xs text-gray-500">{{ appointment.service.name }} · {{ appointment.dog_name }}</p>
                                </div>
                            </div>
                            <select
                                data-appointment-id="{{ appointment.id }}"
                                class="status-select px-2 py-1 text-xs font-medium rounded border border-[#D97706]/30 bg-white text-[#92400E] hover:border-[#D97706] focus:outline-none transition-all cursor-pointer">
                                <option value="pending" selected>Pending</option>
                                <option value="confirmed">Confirm</option>
                                <option value="cancelled">Cancel</option>
                            </select>
                        </div>
                        {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                        <div class="mt-2 pt-2 border-t {% if appointment.same_time_count > 1 %}border-purple-200{% else %}border-indigo-200{% endif %} text-xs {% if appointment.same_time_count > 1 %}text-purple-700 bg-purple-100/50{% else %}text-indigo-700 bg-indigo-100/50{% endif %} px-2 py-1 rounded">
                            <span class="font-medium">Multi-Dog Booking:</span>
                            {% if appointment.same_time_count > 1 %}
                                This customer has {{ appointment.same_time_count }} dogs booked for the same time slot!
                            {% else %}
                                This customer has {{ appointment.same_day_count }} dogs scheduled for today.
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Future Pending Appointments -->
    {% if future_pending %}
        <div class="mb-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
            <h3 class="text-sm font-semibold text-amber-800 mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Upcoming Pending Appointments ({{ future_pending|length }})
            </h3>
            <div class="space-y-2">
                {% regroup future_pending by date as pending_by_date %}
                {% for date in pending_by_date %}
                    <div class="bg-white rounded-lg p-3 border border-amber-100 shadow-sm">
                        <h4 class="text-xs font-semibold text-gray-600 mb-2">{{ date.grouper|date:"l, F j" }}</h4>
                        <div class="space-y-2">
                            {% for appointment in date.list %}
                                <div class="flex items-center justify-between{% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %} py-2{% else %} py-1{% endif %} border-2 {% if appointment.same_time_count > 1 %}border-purple-500 bg-purple-50 px-2 rounded-lg{% elif appointment.same_day_count > 1 %}border-indigo-400 bg-indigo-50 px-2 rounded-lg{% endif %} {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}relative{% endif %}">
                                    {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                    <div class="absolute top-0 right-0 px-2 py-0.5 bg-gradient-to-l {% if appointment.same_time_count > 1 %}from-purple-600 to-purple-500{% else %}from-indigo-600 to-indigo-500{% endif %} text-white text-xs font-bold rounded-bl-lg">
                                        {% if appointment.same_time_count > 1 %}{{ appointment.same_time_count }} DOGS @ Same Time{% else %}{{ appointment.same_day_count }} DOGS Today{% endif %}
                                    </div>
                                    {% endif %}

                                    <div class="flex items-center gap-3{% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %} pr-28{% endif %}">
                                        {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                        <div class="flex-shrink-0">
                                            <svg class="w-5 h-5 {% if appointment.same_time_count > 1 %}text-purple-600{% else %}text-indigo-600{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 2a3 3 0 00-3 3v1a2 2 0 00-2 2v1a2 2 0 102 0V8h.5a3.5 3.5 0 013.5 3.5v.75a.75.75 0 001.5 0v-.75A5 5 0 005.5 6H5V5a3 3 0 013-3zm-2 9.5a2 2 0 00-2 2v.5a.75.75 0 001.5 0v-.5a.5.5 0 01.5-.5h5a.5.5 0 01.5.5v.5a.75.75 0 001.5 0v-.5a2 2 0 00-2-2H8z"/>
                                            </svg>
                                        </div>
                                        {% endif %}
                                        <span class="text-sm font-medium text-gray-700 min-w-[70px]">
                                            {% if appointment.time %}
                                                {{ appointment.time|time:"h:i A" }}
                                            {% else %}
                                                TBA
                                            {% endif %}
                                        </span>
                                        <div>
                                            <p class="text-sm font-medium text-gray-700{% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %} flex items-center gap-1{% endif %}">
                                                {{ appointment.customer.name }}
                                                {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                                <svg class="w-3.5 h-3.5 {% if appointment.same_time_count > 1 %}text-purple-600{% else %}text-indigo-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                </svg>
                                                {% endif %}
                                            </p>
                                            <p class="text-xs text-gray-500">{{ appointment.service.name }} · {{ appointment.dog_name }}</p>
                                        </div>
                                    </div>
                                    <select
                                        data-appointment-id="{{ appointment.id }}"
                                        class="status-select px-2 py-1 text-xs font-medium rounded border border-[#D97706]/30 bg-white text-[#92400E] hover:border-[#D97706] focus:outline-none transition-all cursor-pointer">
                                        <option value="pending" selected>Pending</option>
                                        <option value="confirmed">Confirm</option>
                                        <option value="cancelled">Cancel</option>
                                    </select>
                                </div>
                                {% if appointment.same_time_count > 1 or appointment.same_day_count > 1 %}
                                <div class="mt-1 text-xs {% if appointment.same_time_count > 1 %}text-purple-700 bg-purple-100/50{% else %}text-indigo-700 bg-indigo-100/50{% endif %} px-2 py-0.5 rounded inline-block mx-2">
                                    <span class="font-medium">Multi-Dog:</span> {% if appointment.same_time_count > 1 %}{{ appointment.same_time_count }} dogs same time{% else %}{{ appointment.same_day_count }} dogs same day{% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- No Pending Appointments -->
    {% if not pending_confirmations %}
        <div class="text-center py-12">
            <div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <p class="text-gray-600 font-medium">No pending appointments to review</p>
            <p class="text-gray-400 text-sm mt-1">All appointments are confirmed</p>
        </div>
    {% endif %}

    <!-- Action Notes -->
    <div class="mt-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
        <h4 class="text-xs font-semibold text-gray-700 mb-2">Staff Notes</h4>
        <ul class="text-xs text-gray-600 space-y-1">
            <li>• Review overdue appointments first - these may need to be cancelled or rescheduled</li>
            <li>• Review today's pending appointments second - customers need immediate confirmation</li>
            <li>• Confirm appointments with customers by phone or email before confirming in system</li>
            <li>• Cancel appointments for no-shows using the cancel dropdown</li>
            <li>• All status changes are sent to customers via email automatically</li>
        </ul>
    </div>
</div>

<script>
(function() {
    // Handle appointment status changes
    document.addEventListener('change', function(event) {
        const select = event.target.closest('.status-select');
        if (!select) return;

        const appointmentId = select.getAttribute('data-appointment-id');
        const newStatus = select.value;

        // Disable select while updating
        select.disabled = true;

        // Get CSRF token
        const getCsrfToken = function() {
            const token = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
            if (token) return token;

            const cookieValue = `; ${document.cookie}`;
            const parts = cookieValue.split(`; csrftoken=`);
            if (parts.length === 2) return parts.pop().split(';').shift();

            return '';
        };

        // Update appointment status via API
        fetch('/api/v1/admin/appointments/update-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                appointment_id: appointmentId,
                status: newStatus
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to update status');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success notification
                if (window.showNotification && typeof window.showNotification === 'function') {
                    window.showNotification(data.message || 'Status updated successfully', 'success');
                }

                // Refresh the modal to show updated state
                if (window.closeModal && typeof window.closeModal === 'function') {
                    setTimeout(() => {
                        window.loadModalContent('{% url "pending_review_modal" %}');
                    }, 500);
                }
            } else {
                throw new Error(data.message || 'Update failed');
            }
        })
        .catch(error => {
            console.error('Error updating appointment status:', error);
            if (window.showNotification && typeof window.showNotification === 'function') {
                window.showNotification('Failed to update status: ' + error.message, 'error');
            }
            // Revert select to previous value
            select.value = select.dataset.previousValue || 'pending';
        })
        .finally(() => {
            // Store new value as previous for next change
            select.dataset.previousValue = newStatus;
            // Re-enable select
            select.disabled = false;
        });
    });

    // Store initial values on page load
    document.querySelectorAll('.status-select').forEach(select => {
        select.dataset.previousValue = select.value;
    });
})();
</script>
