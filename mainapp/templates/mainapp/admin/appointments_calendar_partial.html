{% load core_tags %}
<!-- Week Navigation -->
<div class="flex justify-between items-center mb-8 gap-4">
    <button data-action="change-week" data-offset="-1" class="flex items-center px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition hover:shadow-sm">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        <span class="ml-2 text-gray-600 font-medium">Previous</span>
    </button>
    <span class="text-lg font-medium text-gray-800">
        Week of {{ calendar_data.0.date|date:"M j" }} - {{ calendar_data.4.date|date:"M j, Y" }}
    </span>
    <button data-action="change-week" data-offset="1" class="flex items-center px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition hover:shadow-sm">
        <span class="mr-2 text-gray-600 font-medium">Next</span>
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
    </button>
</div>

<!-- All Days in One Container -->
<div class="rounded-lg overflow-hidden border border-gray-200 mb-8 shadow-sm">
    <div class="grid grid-cols-5 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
        {% for day in calendar_data %}
            <div class="px-3 py-2 {% if day.is_today %}bg-blue-100{% endif %} transition-colors">
                <div class="font-semibold text-gray-800 text-sm">{{ day.day_name }}</div>
                <div class="text-xs text-gray-600">{{ day.date|date:"M j" }}</div>
            </div>
        {% endfor %}
    </div>
    <div class="grid grid-cols-5 divide-x divide-gray-200">
        {% for day in calendar_data %}
            <div class="p-2 min-h-40 max-h-64 overflow-y-auto day-cell"
                 data-date="{{ day.date|date:'Y-m-d' }}"
                 data-day-name="{{ day.day_name }}">
                {% if day.appointments %}
                    <div class="space-y-2">
                        {% for appointment in day.appointments|dictsort:"time" %}
                            <div class="bg-gray-50 rounded-md p-2 hover:bg-blue-50 border border-gray-200 hover:border-blue-200 transition-all duration-200 group">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-semibold text-gray-700" style="min-width: 50px;">
                                        {% if appointment.time %}
                                            {% if appointment.time.hour == 0 and appointment.time.minute == 0 %}
                                                <span class="text-red-500" title="Invalid midnight time">00:00</span>
                                            {% else %}
                                                {{ appointment.time|date:"H:i" }}
                                            {% endif %}
                                        {% else %}
                                            <span class="text-red-500" title="Missing time">TBA</span>
                                        {% endif %}
                                    </span>
                                    {% status_badge appointment.status %}
                                </div>
                                <div class="text-sm font-medium text-gray-800 truncate">{{ appointment.customer.name }}</div>
                                <div class="text-xs text-gray-600 truncate">{{ appointment.dog_name }}</div>
                                <div class="text-xs text-gray-500 mt-1 truncate">{{ appointment.service.name }}</div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-400 text-xs text-center py-4">No appointments</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>

<!-- Right Click Context Menu -->
<div id="context-menu" class="hidden fixed bg-white rounded-lg shadow-lg border border-gray-200 py-1 min-w-48" style="z-index: 9998;">
    <button data-action="open-time-slot-editor" class="w-full px-4 py-2 text-left text-sm text-gray-700 flex items-center gap-2" style="transition: background-color 0.2s;">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Edit Time Slots
    </button>

    <div id="copy-options-container" class="hidden border-t border-gray-200 mt-1 pt-1">
        <button data-action="copy-all-groomers" class="w-full px-4 py-2 text-left text-sm text-gray-700 flex items-center gap-2" style="transition: background-color 0.2s;">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Copy ALL Groomers
        </button>

        <div class="relative groomer-menu-trigger">
            <button data-action="copy-specific-groomer" class="w-full px-4 py-2 text-left text-sm text-gray-700 flex items-center justify-between gap-2" style="transition: background-color 0.2s;">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Copy Specific Groomer
                </span>
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>

        <button data-action="paste-copied-slots" class="w-full px-4 py-2 text-left text-sm text-gray-700 flex items-center gap-2" style="transition: background-color 0.2s;">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            Paste Copied Time Slots
        </button>
    </div>
</div>

<!-- Available Time Slots This Week -->
<div class="border-t border-gray-200 pt-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Available Time Slots This Week</h3>
    <div id="available-slots-container">
        <p class="text-gray-400 text-sm">Loading available time slots...</p>
    </div>
</div>

<!-- Groomer Submenu (outside context menu) -->
<div id="groomer-submenu" class="hidden fixed bg-white rounded-lg shadow-lg border border-gray-200 py-1 min-w-48 pointer-events-none" style="z-index: 9999;">
    <div class="px-4 py-2 text-xs font-semibold text-gray-500 border-b border-gray-100">
        Select Groomer
    </div>
    <!-- Groomer options will be dynamically added here -->
</div>

<!-- Custom Confirmation Modal -->
<div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <div class="px-8 py-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">Confirm Action</h3>
        </div>
        <div class="p-8">
            <p id="confirm-modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-modal-cancel" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium">
                    Cancel
                </button>
                <button id="confirm-modal-confirm" class="px-4 py-2 bg-[var(--gold)] text-white rounded-lg hover:bg-[var(--gold-hover)] transition shadow-sm font-medium">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Notification Modal -->
<div id="notification-modal" class="hidden fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <div class="px-8 py-6 border-b border-gray-200">
            <h3 id="notification-modal-title" class="text-xl font-semibold text-gray-800"></h3>
        </div>
        <div class="p-8">
            <p id="notification-modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="notification-modal-close" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
#confirm-modal #confirm-modal-message,
#notification-modal #notification-modal-message {
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>

<script>
(function() {
    'use strict';

    // Store context for time slot editor
    window.contextMenuDate = null;
    window.contextMenuDayName = null;
    window.weekOffset = {{ week_offset }};

    // Clipboarding storage
    window.copiedTimeSlots = null;

    function changeWeek(weekOffset) {
        const container = document.getElementById('appointments-calendar-container');
        if (!container) return;

        // Reload calendar content with new week
        fetch(`/admin/appointments/calendar?week=${weekOffset}`)
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
                // Execute scripts
                const scripts = container.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    newScript.textContent = script.textContent;
                    container.appendChild(newScript);
                });
            })
            .catch(error => {
                console.error('Error changing week:', error);
            });
    }

    window.changeWeek = changeWeek;

    window.loadAvailableTimeSlots = async function loadAvailableTimeSlots() {
        const dayCells = document.querySelectorAll('.day-cell');
        const dates = Array.from(dayCells).map(cell => cell.getAttribute('data-date'));
        const container = document.getElementById('available-slots-container');

        if (!container || dates.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-sm">No dates available.</p>';
            return;
        }

        try {
            const groomersResponse = await fetch('/api/v1/groomers/');
            const groomersData = await groomersResponse.json();
            const groomers = groomersData.data || [];

            if (groomers.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No groomers available.</p>';
                return;
            }

            const groomerIds = groomers.map(g => g.id).join(',');
            const datesString = dates.join(',');

            const batchResponse = await fetch(`/api/v1/admin/time-slots/batch/?groomer_ids=${groomerIds}&dates=${datesString}`);
            const batchData = await batchResponse.json();

            const batchTimeSlots = (batchData.data && batchData.data.time_slots) || [];
            const timeSlotsMap = {};

            for (const slotData of batchTimeSlots) {
                const key = `${slotData.groomer_id}_${slotData.date}`;
                timeSlotsMap[key] = slotData.slots;
            }

            const dayCells = document.querySelectorAll('.day-cell');
            const appointmentsMap = {};

            dayCells.forEach(cell => {
                const date = cell.getAttribute('data-date');
                const appointments = [];
                cell.querySelectorAll('.text-sm.font-semibold.text-gray-700').forEach(el => {
                    const time12 = el.textContent.trim();
                    appointments.push(time12);
                });
                appointmentsMap[date] = appointments;
            });

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';

            for (const groomer of groomers) {
                html += `
                    <div class="bg-white rounded-xl p-5 border border-gray-200 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white font-bold">
                                ${groomer.name.charAt(0).toUpperCase()}
                            </div>
                            <h4 class="font-semibold text-gray-800 text-lg">${groomer.name}</h4>
                        </div>
                        <div class="space-y-3">
                `;

                let hasSlots = false;

                for (const date of dates) {
                    const dateObj = new Date(date + 'T00:00:00');
                    const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                    const key = `${groomer.id}_${date}`;
                    const slots = timeSlotsMap[key] || [];
                    const appointments = appointmentsMap[date] || [];

                    if (slots.length > 0) {
                        hasSlots = true;
                        html += `
                            <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                                <div class="text-sm font-semibold text-green-700 mb-2 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    ${formattedDate}
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${slots.map(slot => `
                                        <span class="px-3 py-1.5 bg-green-50 text-green-700 text-xs font-medium rounded border border-green-200 cursor-default">
                                            ${slot.start}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }

                if (!hasSlots) {
                    html += `
                        <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-100">
                            <p class="text-gray-400 text-sm">No available time slots this week.</p>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;

        } catch (error) {
            console.error('Error loading available time slots:', error);
            container.innerHTML = '<p class="text-red-400 text-sm">Error loading available time slots.</p>';
        }
    };

    window.handleRightClick = function handleRightClick(event, date, dayName) {
        event.preventDefault();
        window.contextMenuDate = date;
        window.contextMenuDayName = dayName;

        const menu = document.getElementById('context-menu');
        if (menu) {
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            menu.classList.remove('hidden');
        }
    };

    window.openTimeSlotEditor = function openTimeSlotEditor() {
        const contextMenu = document.getElementById('context-menu');
        if (contextMenu) {
            contextMenu.classList.add('hidden');
        }

        if (window.PageManager) {
            window.PageManager.openSubPage('time-slots');
        }
    };

    window.setDayTimeSlots = async function setDayTimeSlots(groomId, date, slots) {
        try {
            const response = await fetch('/api/v1/admin/time-slots/set-day/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    groomer_id: groomId,
                    date: date,
                    time_slots: slots.map(s => ({ start: s.start, end: s.end }))
                })
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to set time slots');
            }
            return await response.json();
        } catch (error) {
            console.error('Error setting time slots:', error);
            throw error;
        }
    };

    window.fetchGroomers = async function fetchGroomers() {
        try {
            const response = await fetch('/api/v1/groomers/');
            const data = await response.json();
            return data.data || [];
        } catch (error) {
            console.error('Error fetching groomers:', error);
            return [];
        }
    };

    window.fetchTimeSlots = async function fetchTimeSlots(date, groomerId) {
        try {
            const response = await fetch(`/api/v1/admin/time-slots/day/?groomer_id=${groomerId}&date=${date}`);
            const data = await response.json();
            return (data.data && data.data.slots) || [];
        } catch (error) {
            console.error('Error fetching time slots:', error);
            return [];
        }
    };

    window.copyAllGroomersTimeSlots = async function copyAllGroomersTimeSlots() {
        const date = window.contextMenuDate;
        const groomers = await window.fetchGroomers();
        const timeSlotsData = { date: date, groomers: [] };

        for (const groomer of groomers) {
            const slots = await window.fetchTimeSlots(date, groomer.id);
            if (slots && slots.length > 0) {
                timeSlotsData.groomers.push({
                    groomer_id: groomer.id,
                    groomer_name: groomer.name,
                    slots: slots
                });
            }
        }

        if (timeSlotsData.groomers.length === 0) {
            alert('No time slots found for any groomer on this date.');
            hideContextMenu();
            return;
        }

        window.copiedTimeSlots = timeSlotsData;
        window.copiedTimeSlotsTimestamp = Date.now();
        console.log('All groomers time slots stored in memory');
        hideContextMenu();
    };

    window.copySpecificGroomerTimeSlots = async function copySpecificGroomerTimeSlots(groomerId, groomerName) {
        const date = window.contextMenuDate;
        const slots = await window.fetchTimeSlots(date, groomerId);

        if (!slots || slots.length === 0) {
            alert(`No time slots found for ${groomerName} on this date.`);
            hideContextMenu();
            return;
        }

        const timeSlotsData = {
            date: date,
            groomers: [{
                groomer_id: groomerId,
                groomer_name: groomerName,
                slots: slots
            }]
        };

        window.copiedTimeSlots = timeSlotsData;
        window.copiedTimeSlotsTimestamp = Date.now();
        console.log(`Time slots for ${groomerName} stored in memory`);
        hideContextMenu();
    };

    window.pasteCopiedTimeSlots = async function pasteCopiedTimeSlots() {
        const targetDate = window.contextMenuDate;
        const timeSlotsData = window.copiedTimeSlots;

        if (!timeSlotsData || !timeSlotsData.groomers || timeSlotsData.groomers.length === 0) {
            window.showNotificationModal('Error', 'No copied time slots found. Please copy time slots first.');
            hideContextMenu();
            return;
        }

        const sourceDate = timeSlotsData.date;
        const groomerCount = timeSlotsData.groomers.length;
        const groomerNames = timeSlotsData.groomers.map(g => g.groomer_name).join(', ');

        const confirmMsg = `This will copy time slots from ${sourceDate} to ${targetDate}.\n\n` +
                          `Copying for: ${groomerNames}\n\n` +
                          `Are you sure you want to continue?`;

        window.showConfirmModal(confirmMsg, async () => {
            let successCount = 0;
            let errorMessages = [];

            for (const groomerData of timeSlotsData.groomers) {
                try {
                    await window.setDayTimeSlots(groomerData.groomer_id, targetDate, groomerData.slots);
                    successCount++;
                } catch (error) {
                    console.error(`Failed to paste time slots for ${groomerData.groomer_name}:`, error);
                    errorMessages.push(`${groomerData.groomer_name}: ${error.message || 'Unknown error'}`);
                }
            }

            hideContextMenu();
            window.loadAvailableTimeSlots();

            if (successCount === groomerCount) {
                window.showNotificationModal('Success', `Successfully copied time slots for ${groomerCount} groomer(s) from ${sourceDate} to ${targetDate}.`);
            } else {
                window.showNotificationModal('Partial Success', `Partially successful: ${successCount}/${groomerCount} groomer(s) updated.\n\nErrors:\n${errorMessages.join('\n')}`);
            }
        });
    };

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
               document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }

    window.populateGroomerSubmenu = async function populateGroomerSubmenu(date) {
        console.log('[DEBUG] populateGroomerSubmenu called with date:', date);
        const submenu = document.getElementById('groomer-submenu');
        const existingOptions = submenu.querySelectorAll('.groomer-option');
        existingOptions.forEach(option => option.remove());

        const groomers = await window.fetchGroomers();
        if (groomers.length === 0) {
            return;
        }

        for (const groomer of groomers) {
            const option = document.createElement('button');
            option.className = 'w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-green-100 hover:text-green-800 flex items-center gap-2 groomer-option';
            option.setAttribute('data-action', 'copy-groomer-timeslots');
            option.setAttribute('data-groomer-id', groomer.id);
            option.setAttribute('data-groomer-name', groomer.name);
            option.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                ${groomer.name}
            `;
            submenu.appendChild(option);
        }
    };

    function hideContextMenu() {
        const contextMenu = document.getElementById('context-menu');
        const groomerSubmenu = document.getElementById('groomer-submenu');
        if (contextMenu) {
            contextMenu.classList.add('hidden');
        }
        if (groomerSubmenu) {
            groomerSubmenu.classList.add('hidden');
            groomerSubmenu.classList.add('pointer-events-none');
        }
    }

    window.showConfirmModal = function showConfirmModal(message, onConfirm) {
        const modal = document.getElementById('confirm-modal');
        const messageEl = document.getElementById('confirm-modal-message');
        const cancelBtn = document.getElementById('confirm-modal-cancel');
        const confirmBtn = document.getElementById('confirm-modal-confirm');

        messageEl.textContent = message;

        const newCancelBtn = cancelBtn.cloneNode(true);
        const newConfirmBtn = confirmBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newCancelBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
            hideContextMenu();
        });

        newConfirmBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
            onConfirm();
        });

        modal.classList.remove('hidden');
    };

    window.showNotificationModal = function showNotificationModal(title, message) {
        const modal = document.getElementById('notification-modal');
        const titleEl = document.getElementById('notification-modal-title');
        const messageEl = document.getElementById('notification-modal-message');
        const closeBtn = document.getElementById('notification-modal-close');

        titleEl.textContent = title;
        messageEl.textContent = message;

        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

        newCloseBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
        });

        modal.classList.remove('hidden');
    };

    // Load available time slots when calendar loads
    window.loadAvailableTimeSlots();

    // Close menus on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideContextMenu();
            const confirmModal = document.getElementById('confirm-modal');
            const notificationModal = document.getElementById('notification-modal');
            if (confirmModal && !confirmModal.classList.contains('hidden')) {
                confirmModal.classList.add('hidden');
            }
            if (notificationModal && !notificationModal.classList.contains('hidden')) {
                notificationModal.classList.add('hidden');
            }
        }
    });

    // Close custom modals when clicking outside
    document.addEventListener('click', function(e) {
        const confirmModal = document.getElementById('confirm-modal');
        const notificationModal = document.getElementById('notification-modal');

        if (confirmModal && !confirmModal.classList.contains('hidden') && e.target === confirmModal) {
            confirmModal.classList.add('hidden');
            hideContextMenu();
        }

        if (notificationModal && !notificationModal.classList.contains('hidden') && e.target === notificationModal) {
            notificationModal.classList.add('hidden');
        }
    });

    // Event delegation
    document.addEventListener('click', async function(event) {
        const clickInContextMenu = event.target.closest('#context-menu');
        const clickInSubmenu = event.target.closest('#groomer-submenu');
        const clickInDayCell = event.target.closest('.day-cell');

        if (!clickInContextMenu && !clickInSubmenu && !clickInDayCell) {
            hideContextMenu();
        }

        const changeWeekBtn = event.target.closest('[data-action="change-week"]');
        if (changeWeekBtn) {
            const offset = parseInt(changeWeekBtn.getAttribute('data-offset'));
            changeWeek(window.weekOffset + offset);
        }

        const openTimeSlotBtn = event.target.closest('[data-action="open-time-slot-editor"]');
        if (openTimeSlotBtn) {
            openTimeSlotEditor();
        }

        const copyAllBtn = event.target.closest('[data-action="copy-all-groomers"]');
        if (copyAllBtn) {
            await window.copyAllGroomersTimeSlots();
        }

        const copyGroomerBtn = event.target.closest('[data-action="copy-groomer-timeslots"]');
        if (copyGroomerBtn) {
            event.stopPropagation();
            const groomerId = parseInt(copyGroomerBtn.getAttribute('data-groomer-id'));
            const groomerName = copyGroomerBtn.getAttribute('data-groomer-name');
            await window.copySpecificGroomerTimeSlots(groomerId, groomerName);
        }

        const pasteBtn = event.target.closest('[data-action="paste-copied-slots"]');
        if (pasteBtn) {
            event.stopPropagation();
            await window.pasteCopiedTimeSlots();
        }
    });

    // Handle right-click on day cells
    document.addEventListener('contextmenu', async function(event) {
        const dayCell = event.target.closest('.day-cell');
        if (dayCell) {
            event.preventDefault();
            window.contextMenuDate = dayCell.getAttribute('data-date');
            window.contextMenuDayName = dayCell.getAttribute('data-day-name');

            const menu = document.getElementById('context-menu');
            const copyOptionsContainer = document.getElementById('copy-options-container');
            const groomerSubmenu = document.getElementById('groomer-submenu');

            if (menu) {
                if (groomerSubmenu) {
                    groomerSubmenu.classList.add('hidden');
                }

                menu.style.left = event.clientX + 'px';
                menu.style.top = event.clientY + 'px';
                menu.classList.remove('hidden');

                copyOptionsContainer.classList.remove('hidden');
                await window.populateGroomerSubmenu(window.contextMenuDate);
            }
        }
    });

    // Hover effects for context menu
    const contextMenu = document.getElementById('context-menu');
    if (contextMenu) {
        contextMenu.addEventListener('mouseover', function(event) {
            const button = event.target.closest('button');
            if (button) {
                button.style.backgroundColor = '#e0e7ff';
                button.style.color = '#1e40af';
            }
        });

        contextMenu.addEventListener('mouseout', function(event) {
            const button = event.target.closest('button');
            if (button) {
                button.style.backgroundColor = '';
                button.style.color = '';
            }
        });
    }

    // Hover effects for groomer submenu
    const groomerSubmenu = document.getElementById('groomer-submenu');
    if (groomerSubmenu) {
        groomerSubmenu.addEventListener('mouseover', function(event) {
            const button = event.target.closest('button');
            if (button) {
                button.style.backgroundColor = '#dcfce7';
                button.style.color = '#166534';
            }
        });

        groomerSubmenu.addEventListener('mouseout', function(event) {
            const button = event.target.closest('button');
            if (button) {
                button.style.backgroundColor = '';
                button.style.color = '';
            }
        });
    }
})();
</script>
