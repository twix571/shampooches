{% load static %}
<div class="p-6" id="pricing-preview-content">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-semibold text-gray-800">Pricing Table: {{ breed.name }}</h2>
            {% if breed.pricing_cloned_from %}
            <p class="text-sm text-amber-600 mt-1 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Cloned from {{ breed.pricing_cloned_from.name }}{% if breed.clone_note %}: {{ breed.clone_note }}{% endif %}
            </p>
            {% endif %}
            {% if breed.breed_pricing_complex %}
            <p class="text-sm text-red-600 mt-1 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77-1.333.192-3 1.732 3z"></path>
                </svg>
                Complex Pricing - Manual Review Required
            </p>
            {% endif %}
        </div>
        <button onclick="closeModal()" class="px-3 py-1 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Breed Base Price Section -->
    <div class="bg-teal-50 border border-teal-100 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-800">Breed Base Price</h3>
                <p class="text-sm text-gray-600">Starting price for services requiring bath/grooming (e.g., Full Groom, Bath & Brush)</p>
            </div>
            <div id="base-price-display" class="flex items-center gap-4">
                <div class="text-2xl font-bold text-teal-700">
                    ${{ breed.base_price|default:"0.00"|floatformat:2 }}
                </div>
                <button onclick="showBasePriceEdit()" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-700 transition text-sm">
                    Edit Price
                </button>
            </div>
            <div id="base-price-edit" class="flex items-center gap-4 w-full hidden">
                <div class="flex-1 flex items-center gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Base Price ($)</label>
                        <input type="number" step="0.01" min="0" id="base-price-input" value="{{ breed.base_price|default:"0.00"|floatformat:2 }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveBasePrice()" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-700 transition">
                            Save
                        </button>
                        <button onclick="cancelBasePriceEdit()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weight Pricing Configuration -->
    <div class="bg-teal-50 border border-teal-100 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-gray-800">Weight Pricing Formula</h3>
            <button onclick="openWeightRangesEditor()" class="text-sm text-teal-600 hover:text-teal-700 underline">
                Edit Weight Pricing
            </button>
        </div>
        {% if breed.weight_range_amount and breed.weight_price_amount %}
        <div class="text-gray-700">
            <span class="font-medium">{{ breed.weight_range_amount }} lbs</span> over <span class="font-medium">{{ breed.start_weight|default:"0" }} lbs</span> adds <span class="font-medium">${{ breed.weight_price_amount|floatformat:2 }}</span>
        </div>
        <div class="text-sm text-gray-500 mt-1">
            Example: For a 25 lb dog with settings (10 lbs = +$15, starts at 15 lbs): (25 - 15) / 10 = 1 increment â†’ +$15
        </div>
        {% else %}
        <div class="text-gray-500 italic">No weight pricing configured. Click "Edit Weight Pricing" to set it up.</div>
        {% endif %}
    </div>

    <!-- Pricing Table -->
    {% if sample_weights %}
    <div class="overflow-x-auto">
        <table class="min-w-full border-collapse">
            <thead>
                <tr>
                    <th class="bg-gray-100 border border-gray-300 px-4 py-3 text-left text-sm font-semibold text-gray-700 min-w-[180px]">
                        Dog Weight
                    </th>
                    {% for service in services %}
                    <th class="bg-gray-100 border border-gray-300 px-4 py-3 text-center text-sm font-semibold text-gray-700 min-w-[140px]">
                        <div>{{ service.name }}</div>
                        {% if service.exempt_from_surcharge %}
                        <div class="text-xs text-teal-600 font-normal">(Exempt from surcharge)</div>
                        {% endif %}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for sample in sample_weights %}
                <tr>
                    <td class="bg-gray-50 border border-gray-300 px-4 py-3">
                        <div class="font-medium text-gray-800 text-sm">{{ sample.label }}</div>
                        <div class="text-xs text-gray-500">{{ sample.description }}</div>
                        {% for service in services %}
                        {% if sample.weight == breed.start_weight %}
                        {% with surcharge=pricing_data.weight_surcharge %}
                        <div class="text-xs text-teal-600 mt-1">No surcharge</div>
                        {% endwith %}
                        {% else %}
                        {% with weight_info=pricing_matrix|get_item:service.id|get_item:sample.key %}
                        <div class="text-xs text-teal-600 mt-1">+${{ weight_info.weight_surcharge|floatformat:2 }} surcharge</div>
                        {% endwith %}
                        {% endif %}
                        {% endfor %}
                    </td>
                    {% for service in services %}
                    {% with price_data=pricing_matrix|get_item:service.id|get_item:sample.key %}
                    <td class="border border-gray-300 px-4 py-3 text-center price-cell" data-service="{{ service.id }}" data-weight="{{ sample.key }}">
                        <div class="price-display text-lg font-semibold text-gray-800">
                            ${{ price_data.final_price|floatformat:2 }}
                        </div>
                        <div class="price-components text-xs text-gray-500 mt-1">
                            Base: ${{ price_data.base_price|floatformat:2 }}
                            {% if price_data.weight_surcharge > 0 %}
                            + Surcharge: ${{ price_data.weight_surcharge|floatformat:2 }}
                            {% endif %}
                        </div>
                    </td>
                    {% endwith %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
        <div class="text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-lg font-medium mb-2">No pricing data available</p>
            <p class="text-sm mb-4">Configure weight pricing for this breed to see the complete pricing table.</p>
            <button onclick="openWeightRangesEditor()" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-700 transition">
                Configure Weight Pricing
            </button>
        </div>
    </div>
    {% endif %}

    <div class="flex justify-end gap-3 mt-6">
        <button onclick="showClonePricingModal()" class="px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600 transition flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Clone Pricing
        </button>
        <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition">Close</button>
    </div>
</div>

<script>
const BREED_ID = {{ breed.id }};



function showBasePriceEdit() {
    document.getElementById('base-price-display').classList.add('hidden');
    document.getElementById('base-price-edit').classList.remove('hidden');
    document.getElementById('base-price-edit').classList.add('flex');
}

function cancelBasePriceEdit() {
    document.getElementById('base-price-display').classList.remove('hidden');
    document.getElementById('base-price-edit').classList.add('hidden');
    document.getElementById('base-price-edit').classList.remove('flex');
}

function getCsrfToken() {
    const token = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (token) return token.value;
    if (window.parent && window.parent !== window) {
        const parentToken = window.parent.document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (parentToken) return parentToken.value;
    }
    const cookieValue = `; ${document.cookie}`;
    const parts = cookieValue.split(`; csrftoken=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
}

async function saveBasePrice() {
    const priceInput = document.getElementById('base-price-input');
    const newPrice = parseFloat(priceInput.value);

    if (isNaN(newPrice) || newPrice < 0) {
        alert('Please enter a valid price');
        return;
    }

    const csrfToken = getCsrfToken();

    try {
        const response = await fetch(`/api/breeds/${BREED_ID}/update-base-price/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                base_price: newPrice
            })
        });

        const result = await response.json();

        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Failed to update base price'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function openWeightRangesEditor() {
    if (window.parent && window.parent !== window) {
        window.parent.dispatchEvent(new CustomEvent('open-modal', {
            detail: { url: `/admin/weight-ranges-editor-modal/${BREED_ID}/` }
        }));
    } else {
        window.location.href = `/admin/weight-ranges-editor-modal/${BREED_ID}/`;
    }
}

function showClonePricingModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
    modal.id = 'clone-modal-overlay';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Clone Pricing from Another Breed</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Clone pricing configuration to this breed from:</label>
                    <select id="source-breed-select" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <option value="">Select a breed...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Clone Note (optional)</label>
                    <input type="text" id="clone-note-input" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Why clone this pricing?">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeCloneModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition">Cancel</button>
                <button onclick="executeClone()" class="px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600 transition">Clone</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    fetch('/api/v1/breeds/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('source-breed-select');
            if (select && data.data) {
                data.data.forEach(breed => {
                    const option = document.createElement('option');
                    option.value = breed.id;
                    option.text = breed.id === BREED_ID ? breed.name + ' (this breed)' : breed.name;
                    if (breed.id === BREED_ID) {
                        option.disabled = true;
                    }
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error fetching breeds:', error);
        });
}

function closeCloneModal() {
    const modal = document.getElementById('clone-modal-overlay');
    if (modal) {
        modal.remove();
    }
}

async function executeClone() {
    const sourceBreedId = document.getElementById('source-breed-select').value;
    const cloneNote = document.getElementById('clone-note-input').value;

    if (!sourceBreedId) {
        alert('Please select a source breed');
        return;
    }

    const csrfToken = getCsrfToken();

    try {
        const response = await fetch('/admin/clone-breed-pricing/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                source_breed_id: sourceBreedId,
                target_breed_id: BREED_ID,
                clone_note: cloneNote
            })
        });

        const result = await response.json();

        if (result.success) {
            alert('Pricing cloned successfully!');
            closeCloneModal();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
